const nodemailer = require('nodemailer');
const Stripe = require('stripe');
const stripe = Stripe(process.env.STRIPE_SECRET_KEY);

export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method Not Allowed' });
    }

    try {
        // 1. Receive the downloadUrl (from Blob) and other details
        const { title, price, accountId, email, downloadUrl } = JSON.parse(req.body);

        if (!accountId) return res.status(400).json({ error: 'No connected account found' });

        const priceInCents = Math.round(price * 100);
        const platformFee = Math.round(priceInCents * 0.05);

        // 2. Create Price
        const priceRecord = await stripe.prices.create({
            currency: 'usd',
            unit_amount: priceInCents,
            product_data: { name: title },
        }, { stripeAccount: accountId });

        // 3. Create Payment Link with REDIRECT & METADATA
        const paymentLink = await stripe.paymentLinks.create({
            line_items: [{ price: priceRecord.id, quantity: 1 }],
            application_fee_amount: platformFee,
            
            // --- ADDED: AUTO-REDIRECT AFTER PAYMENT ---
            after_completion: {
                type: 'redirect',
                redirect: {
                    url: downloadUrl 
                }
            },

            // Metadata for the Webhook (to send Email #2)
            metadata: {
                downloadUrl: downloadUrl, 
                buyerEmail: email,
                assetTitle: title
            }
        }, { stripeAccount: accountId });

        // 4. SEND EMAIL #1 (The Payment Request)
        if (email) {
            const transporter = nodemailer.createTransport({
                service: "gmail",
                auth: {
                    user: process.env.EMAIL_USER,
                    pass: process.env.EMAIL_PASS
                }
            });

            await transporter.sendMail({
                from: `"QuickAsset" <${process.env.EMAIL_USER}>`,
                to: email,
                subject: `Access Your Asset: ${title}`,
                html: `
                    <div style="font-family: sans-serif; color: #1e293b; max-width: 500px;">
                        <h2 style="color: #0f172a;">Asset Ready: ${title}</h2>
                        <p>You have requested access to this asset. Click the button below to complete the secure transaction via Stripe.</p>
                        
                        <p style="margin: 24px 0;">
                            <a href="${paymentLink.url}" style="background-color: #F97316; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">
                                Purchase Asset ($${price})
                            </a>
                        </p>
                
                        <p style="font-size: 12px; color: #64748b; margin-top: 32px; border-top: 1px solid #e2e8f0; padding-top: 12px;">
                            Secure link generated by QuickAsset.<br>
                            If the button doesn't work, copy this link: <a href="${paymentLink.url}" style="color: #64748b;">${paymentLink.url}</a>
                        </p>
                    </div>`
            });
        }

        return res.status(200).json({ url: paymentLink.url });

    } catch (error) {
        console.error("Stripe Error:", error);
        return res.status(500).json({ error: error.message });
    }
}
