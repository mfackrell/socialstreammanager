<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickAsset Terminal | SocialStream</title>
    
    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    serif: ['Crimson Pro', 'serif'],
                    sans: ['Lato', 'sans-serif'],
                },
                extend: {
                    colors: {
                        brand: {
                            cream: '#FAF9F6',   
                            sand: '#F2EFE9',    
                            text: '#4A4A4A',    
                            dark: '#2C2C2C',    
                            accent: '#8FA89B',  
                            accentLight: '#E3EBE6',
                            rose: '#D4A5A5',    
                        }
                    },
                    animation: {
                        'float': 'float 4s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FAF9F6; color: #4A4A4A; }
        h1, h2, h3, h4 { letter-spacing: -0.01em; }
        p { line-height: 1.7; }
        .soft-card { 
            background: white; 
            border-radius: 32px; 
            border: 1px solid rgba(0,0,0,0.04);
            box-shadow: 0 10px 40px rgba(0,0,0,0.03);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary {
            background-color: #8FA89B;
            color: white;
            padding: 14px 32px;
            border-radius: 50px;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(143, 168, 155, 0.2);
        }
        .btn-primary:hover {
            background-color: #7E9689;
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(143, 168, 155, 0.25);
        }
        .input-field {
            background: #FAF9F6;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .input-field:focus {
            background: white;
            border-color: #8FA89B;
            outline: none;
            box-shadow: 0 0 0 4px rgba(143,168,155,0.1);
        }
    </style>
</head>
<body class="antialiased font-sans min-h-screen flex flex-col">

    <!-- NAVIGATION -->
    <nav class="fixed top-0 w-full bg-brand-cream/80 backdrop-blur-xl z-50 border-b border-black/[0.03]">
        <div class="max-w-6xl mx-auto px-6 h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 group">
                <span class="font-serif text-2xl font-semibold text-brand-dark italic tracking-tight">SocialStream</span>
                <span class="bg-brand-accent/10 text-brand-accent px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-widest mt-1">Terminal</span>
            </a>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-brand-accentLight border border-brand-accent/20">
                    <div class="w-1.5 h-1.5 rounded-full bg-brand-accent animate-pulse"></div>
                    <span class="text-[10px] font-bold text-brand-accent uppercase tracking-widest">System Online</span>
                </div>
                <div class="w-10 h-10 bg-brand-sand rounded-full border border-black/5 flex items-center justify-center text-xs font-bold text-brand-text">ME</div>
            </div>
        </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main class="flex-1 pt-32 pb-24 px-6 max-w-5xl mx-auto w-full">
        
        <!-- Payout Status Banner -->
        <section class="mb-12">
            <div class="soft-card p-6 md:p-8 flex flex-col md:flex-row items-center justify-between gap-6 bg-white">
                <div class="flex items-start gap-5">
                    <div class="p-4 bg-brand-accentLight rounded-2xl">
                        <i data-lucide="credit-card" class="w-6 h-6 text-brand-accent"></i>
                    </div>
                    <div>
                        <h2 class="font-serif text-xl text-brand-dark italic">Payout Destination</h2>
                        <p class="text-sm text-brand-text/60 mt-0.5 font-light" id="stripe-status-text">Connect Stripe to enable instant asset generation.</p>
                    </div>
                </div>
                
                <button id="btn-connect-stripe" onclick="handleStripeConnect()" class="btn-primary shadow-none bg-brand-dark hover:bg-brand-text">
                    <i data-lucide="link-2" class="w-4 h-4"></i> Connect Stripe
                </button>

                <div id="stripe-connected-badge" class="hidden flex items-center gap-3 bg-brand-accentLight border border-brand-accent/20 px-5 py-2.5 rounded-full text-brand-accent text-xs font-bold uppercase tracking-widest">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    Account Active
                </div>
            </div>
        </section>

        <!-- Configuration Panel -->
        <section id="asset-panel" class="opacity-40 pointer-events-none transition-all duration-700">
            <div class="flex items-center justify-between mb-8">
                <h1 class="font-serif text-3xl md:text-4xl text-brand-dark">New Asset Configuration</h1>
                <span class="text-[10px] font-bold text-brand-accent bg-brand-accentLight px-3 py-1 rounded-full border border-brand-accent/10 uppercase tracking-widest">Draft Mode</span>
            </div>

            <div class="grid md:grid-cols-[1.6fr_1fr] gap-10">
                <div class="space-y-8">
                    <!-- Upload Zone -->
                    <div>
                        <label class="block text-[10px] font-bold text-brand-text/40 uppercase tracking-[0.2em] mb-3 ml-1">01 // Asset Payload</label>
                        <div id="drop-zone" class="h-56 border-2 border-dashed border-brand-sand bg-brand-cream/50 rounded-[32px] flex flex-col items-center justify-center cursor-pointer transition-all hover:bg-white hover:border-brand-accent/40 group relative overflow-hidden">
                            <div id="drop-content-default" class="flex flex-col items-center z-10">
                                <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center mb-5 shadow-sm border border-brand-sand group-hover:scale-110 transition-transform">
                                    <i data-lucide="upload-cloud" class="w-8 h-8 text-brand-accent/40 group-hover:text-brand-accent transition-colors"></i>
                                </div>
                                <p class="text-sm font-bold text-brand-dark">Click or drag your asset</p>
                                <p class="text-xs text-brand-text/40 mt-1 font-light italic">MP4, PDF, ZIP (Max 2GB)</p>
                            </div>
                            <div id="drop-content-uploaded" class="hidden flex-col items-center z-10 w-full px-10">
                                <i data-lucide="file-check" class="w-10 h-10 text-brand-accent mb-3"></i>
                                <p id="file-name" class="text-sm font-bold text-brand-dark truncate w-full text-center">filename.zip</p>
                                <p class="text-[10px] text-brand-accent font-bold uppercase tracking-widest mt-1">Upload Complete</p>
                            </div>
                            <div id="upload-progress" class="absolute bottom-0 left-0 h-1.5 bg-brand-accent transition-all duration-300 w-0"></div>
                        </div>
                        <input type="file" id="file-input" class="hidden">
                    </div>

                    <!-- Inputs -->
                    <div class="grid gap-8">
                        <div>
                            <label class="block text-[10px] font-bold text-brand-text/40 uppercase tracking-[0.2em] mb-3 ml-1">02 // Designation</label>
                            <input type="text" id="input-title" placeholder="e.g. Masterclass Template" class="w-full rounded-2xl p-5 text-brand-dark placeholder:text-brand-text/30 input-field font-serif italic text-lg shadow-inner">
                        </div>

                        <div>
                            <label class="flex items-center justify-between text-[10px] font-bold text-brand-text/40 uppercase tracking-[0.2em] mb-3 ml-1">
                                <span>03 // Target Buyer</span>
                                <span class="text-[9px] bg-brand-sand px-2 py-0.5 rounded-full text-brand-text/60 italic lowercase">Optional</span>
                            </label>
                            <div class="relative group">
                                <i data-lucide="mail" class="absolute left-5 top-1/2 -translate-y-1/2 w-4 h-4 text-brand-text/30 group-focus-within:text-brand-accent transition-colors"></i>
                                <input type="email" id="input-email" placeholder="client@company.com" class="w-full pl-12 pr-5 py-4 rounded-2xl input-field text-sm font-light shadow-inner">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price/Action Card -->
                <div class="flex flex-col">
                    <div class="soft-card p-10 bg-white border-none shadow-xl flex-1 flex flex-col">
                        <label class="block text-[10px] font-bold text-brand-text/40 uppercase tracking-[0.2em] mb-6 text-center">Valuation</label>
                        
                        <div class="relative mb-10 text-center">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-brand-text/20 text-2xl font-serif italic">$</span>
                            <input type="number" id="input-price" placeholder="0.00" class="w-full bg-transparent border-b border-brand-sand py-4 text-6xl font-serif italic text-brand-dark placeholder:text-brand-sand focus:outline-none focus:border-brand-accent text-center transition-all">
                        </div>

                        <div class="mt-auto space-y-4">
                            <div class="bg-brand-cream rounded-2xl p-6 border border-brand-sand">
                                <div class="flex justify-between text-xs text-brand-text/50 mb-3 font-light">
                                    <span>Platform Fee (5%)</span>
                                    <span id="fee-calc" class="font-bold">$0.00</span>
                                </div>
                                <div class="flex justify-between text-base text-brand-accent font-bold border-t border-brand-sand/50 pt-3">
                                    <span class="font-serif italic text-brand-dark">Net Revenue</span>
                                    <span id="net-calc" class="font-serif text-lg">$0.00</span>
                                </div>
                            </div>

                            <button id="btn-generate" onclick="generateAsset()" class="w-full btn-primary justify-center text-lg py-5 shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="zap" class="w-5 h-5"></i>
                                Create Secure Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Success Modal -->
        <div id="modal-success" class="fixed inset-0 bg-brand-dark/80 backdrop-blur-md z-[100] hidden items-center justify-center p-4">
            <div class="soft-card bg-white max-w-md w-full p-10 relative overflow-hidden text-center shadow-2xl">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-brand-accent"></div>
                
                <div class="w-20 h-20 bg-brand-accentLight rounded-full flex items-center justify-center mx-auto mb-6 border border-brand-accent/20 animate-bounce">
                    <i data-lucide="check" class="w-10 h-10 text-brand-accent"></i>
                </div>
                
                <h3 class="font-serif text-3xl text-brand-dark italic mb-2">Asset Deployed.</h3>
                <p class="text-sm text-brand-text/50 font-light mb-8">Your secure link is ready for transaction.</p>
                
                <div class="bg-brand-cream border border-brand-sand rounded-2xl p-5 mb-8 text-left">
                    <p class="text-[9px] text-brand-text/40 uppercase font-bold tracking-widest mb-3">Unique Checkout URL</p>
                    <div class="flex items-center justify-between gap-4">
                        <a id="generated-link" href="#" target="_blank" class="text-brand-accent font-bold text-sm truncate hover:underline transition-colors">...</a>                        
                        <button id="btn-copy" class="text-brand-text/30 hover:text-brand-accent transition-colors flex-shrink-0">
                            <i data-lucide="copy" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="email-confirm-msg" class="hidden bg-brand-accentLight border border-brand-accent/20 rounded-2xl p-4 mb-8 flex items-start gap-4 text-left">
                    <i data-lucide="mail-check" class="w-5 h-5 text-brand-accent mt-0.5"></i>
                    <div class="text-xs text-brand-accent font-medium leading-relaxed">
                        <span class="font-bold">Sent:</span> Link and confirmation invoice emailed to <span id="confirm-email-addr" class="underline"></span>
                    </div>
                </div>

                <button onclick="resetForm()" class="text-brand-text/40 hover:text-brand-dark text-xs font-bold uppercase tracking-widest border-b border-transparent hover:border-brand-dark pb-1 transition-all">Create Another Link</button>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-brand-cream border-t border-brand-sand py-12 px-6 mt-auto">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-8">
            <div class="flex items-center gap-2">
                <span class="font-serif text-xl font-bold text-brand-dark italic">SocialStream</span>
                <span class="text-brand-text/30 font-bold uppercase text-[9px] tracking-[0.3em] mt-1">Ecosystem</span>
            </div>
            <div class="text-[10px] text-brand-text/40 uppercase font-bold tracking-widest">
                Â© 2024 SocialStream Ecosystem. Built for Creators.
            </div>
        </div>
    </footer>

    <script type="module">
        import { upload } from 'https://esm.sh/@vercel/blob/client';

        const STRIPE_CLIENT_ID = 'ca_TTJhaOfvv4bclxzQigX2cG6X1kUJyjTj'; 
        const REDIRECT_URI =  'https://socialstreammanager.com/app.html';
        const API_BASE_URL = window.QUICKASSET_API_BASE_URL
            || window.localStorage?.getItem('quickasset_api_base')
            || (window.location.hostname === 'socialstreammanager.com'
                ? 'https://socialstreammanager.vercel.app'
                : window.location.origin);

        const apiUrl = (path) => new URL(path, API_BASE_URL).toString();
        
        if (typeof lucide !== 'undefined') lucide.createIcons();

        let state = { stripeConnected: false, stripeAccountId: null, fileUploaded: false, fileObject: null, price: 0, title: '', email: '' };

        const stripeBtn = document.getElementById('btn-connect-stripe');
        const stripeBadge = document.getElementById('stripe-connected-badge');
        const stripeText = document.getElementById('stripe-status-text');
        const assetPanel = document.getElementById('asset-panel');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const priceInput = document.getElementById('input-price');
        const titleInput = document.getElementById('input-title');
        const emailInput = document.getElementById('input-email');
        
        window.handleStripeConnect = function() {
            stripeBtn.disabled = true;
            stripeBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Redirecting...`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            const stripeUrl = `https://connect.stripe.com/oauth/authorize?response_type=code&client_id=${STRIPE_CLIENT_ID}&scope=read_write&redirect_uri=${REDIRECT_URI}`;
            window.location.href = stripeUrl;
        }

        window.onload = async function() {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code')) {
                const tempCode = urlParams.get('code');
                stripeBtn.classList.add('hidden');
                stripeBadge.classList.remove('hidden');
                stripeBadge.classList.add('flex');
                stripeBadge.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Verifying...`;
                if (typeof lucide !== 'undefined') lucide.createIcons();

                try {
                    const exchangeUrl = new URL('/api/exchange-token', API_BASE_URL);
                    const payload = { code: tempCode, redirect_uri: REDIRECT_URI };
                    let response = await fetch(exchangeUrl.toString(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 405) {
                        exchangeUrl.searchParams.set('code', tempCode);
                        exchangeUrl.searchParams.set('redirect_uri', REDIRECT_URI);
                        response = await fetch(exchangeUrl.toString(), { method: 'GET' });
                    }
                    if (!response.ok) {
                        const errorText = await response.text(); // Get the HTML error page text
                        console.error('Server Error:', errorText);
                        return;
                    }
                    
                    const data = await response.json();

                    if (data.stripe_user_id) {
                        state.stripeConnected = true;
                        state.stripeAccountId = data.stripe_user_id;

                        stripeBadge.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i> Account Active`;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        stripeText.textContent = "Payouts enabled via Stripe Connect.";
                        stripeText.classList.remove('text-brand-text/60');
                        stripeText.classList.add('text-brand-accent');
                        assetPanel.classList.remove('opacity-40', 'pointer-events-none');
                    } else {
                        alert('Connection failed: ' + JSON.stringify(data));
                        stripeBtn.classList.remove('hidden');
                        stripeBadge.classList.add('hidden');
                    }
                } catch (err) {
                    console.error(err);
                    stripeBtn.classList.remove('hidden');
                    stripeBadge.classList.add('hidden');
                }
            }
        };

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-brand-accent', 'bg-white'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-brand-accent', 'bg-white'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-brand-accent', 'bg-white');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            state.fileObject = file;
            const progressBar = document.getElementById('upload-progress');
            progressBar.style.width = '10%';
            let width = 10;
            const interval = setInterval(() => {
                if (width >= 100) { clearInterval(interval); finishUpload(file); } 
                else { width += 10; progressBar.style.width = width + '%'; }
            }, 80); 
        }

        function finishUpload(file) {
            document.getElementById('drop-content-default').classList.add('hidden');
            const uploadedState = document.getElementById('drop-content-uploaded');
            uploadedState.classList.remove('hidden');
            uploadedState.classList.add('flex');
            document.getElementById('file-name').textContent = file.name;
            state.fileUploaded = true;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        priceInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value) || 0;
            state.price = val;
            const fee = val * 0.05;
            const net = val - fee;
            document.getElementById('fee-calc').textContent = '$' + fee.toFixed(2);
            document.getElementById('net-calc').textContent = '$' + net.toFixed(2);
        });

        window.generateAsset = async function() {
            state.title = titleInput.value; 
            state.email = emailInput.value;
            
            if (!state.fileUploaded) { dropZone.classList.add('animate-shake'); setTimeout(() => dropZone.classList.remove('animate-shake'), 500); return; }
            if (!state.title) { titleInput.focus(); return; }
            if (state.price <= 0) { priceInput.focus(); return; }

            const btn = document.getElementById('btn-generate');
            
            try {
                btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Processing...`;
                if (typeof lucide !== 'undefined') lucide.createIcons();

                const newBlob = await upload(state.fileObject.name, state.fileObject, {
                    access: 'public',
                    handleUploadUrl: apiUrl('/api/upload-url'),
                });

                const response = await fetch(apiUrl('/api/create-payment-link'), {
                    method: 'POST',
                    body: JSON.stringify({
                        title: state.title,
                        price: state.price,
                        accountId: state.stripeAccountId,
                        email: state.email,
                        downloadUrl: newBlob.url 
                    })
                });

                const data = await response.json();
                if (data.url) showSuccess(data.url);
                else alert("Error: " + (data.error || "Unknown"));

            } catch (error) {
                console.error(error);
                alert("Failed: " + error.message);
            }
            
            btn.innerHTML = `<i data-lucide="zap" class="w-5 h-5"></i> Create Secure Link`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function showSuccess(url) {
            const modal = document.getElementById('modal-success');
            const linkCode = document.getElementById('generated-link');
            linkCode.textContent = url;
            linkCode.href = url;

            const emailMsg = document.getElementById('email-confirm-msg');
            if (state.email) { 
                emailMsg.classList.remove('hidden'); 
                document.getElementById('confirm-email-addr').textContent = state.email;
            } else { 
                emailMsg.classList.add('hidden'); 
            }
            
            modal.classList.remove('hidden'); 
            modal.classList.add('flex');
            if (typeof lucide !== 'undefined') lucide.createIcons();

            const copyBtn = document.getElementById('btn-copy');
            copyBtn.onclick = () => {
                const link = document.getElementById('generated-link').textContent;
                navigator.clipboard.writeText(link).then(() => {
                    copyBtn.innerHTML = `<i data-lucide="check" class="w-5 h-5 text-brand-accent"></i>`;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    setTimeout(() => {
                        copyBtn.innerHTML = `<i data-lucide="copy" class="w-5 h-5"></i>`;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }, 2000);
                });
            };
        }

        window.resetForm = function() {
            document.getElementById('modal-success').classList.add('hidden');
            document.getElementById('modal-success').classList.remove('flex');
            titleInput.value = ''; priceInput.value = ''; emailInput.value = '';
            document.getElementById('fee-calc').textContent = '$0.00';
            document.getElementById('net-calc').textContent = '$0.00';
            state.fileUploaded = false;
            state.fileObject = null;
            document.getElementById('upload-progress').style.width = '0';
            document.getElementById('drop-content-default').classList.remove('hidden');
            document.getElementById('drop-content-uploaded').classList.add('hidden');
            document.getElementById('drop-content-uploaded').classList.remove('flex');
        }
    </script>
</body>
</html>
